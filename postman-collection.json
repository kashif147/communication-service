{
  "info": {
    "name": "Communication Service API",
    "description": "Complete API collection for Communication Service with authentication and OneDrive integration.\n\n**Setup Requirements:**\n- JWT Bearer token from user-service for authentication\n- Microsoft Graph API configured for OneDrive/SharePoint access\n- See GRAPH_API_SETUP.md for Graph API configuration\n\n**Environment Variables (Service):**\n- GRAPH_CLIENT_ID: Microsoft Graph App Registration Client ID\n- GRAPH_CLIENT_SECRET: Microsoft Graph App Registration Client Secret\n- GRAPH_TENANT_ID: Azure AD Tenant ID\n- ONEDRIVE_TEMPLATE_FOLDER_ID: OneDrive/SharePoint folder ID for template storage\n- ONEDRIVE_USER_EMAIL: (Optional) User email for application permissions",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "2.1.0"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:4000",
      "type": "string",
      "description": "Base URL for the Communication Service. For Azure: https://communicationserviceshell-eab5cfgdbccnf6b0.northeurope-01.azurewebsites.net"
    },
    {
      "key": "authToken",
      "value": "",
      "type": "string",
      "description": "JWT Bearer token from user-service. Required for all authenticated endpoints. userId and tenantId are extracted from this token automatically."
    },
    {
      "key": "templateId",
      "value": "",
      "type": "string",
      "description": "Template ID (24-character MongoDB ObjectId)"
    },
    {
      "key": "bookmarkFieldId",
      "value": "",
      "type": "string",
      "description": "Bookmark Field ID (24-character MongoDB ObjectId)"
    },
    {
      "key": "memberId",
      "value": "",
      "type": "string",
      "description": "Member ID (24-character MongoDB ObjectId) for whom the letter is being generated"
    }
  ],
  "item": [
    {
      "name": "Health & Info",
      "item": [
        {
          "name": "Health Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/health",
              "host": ["{{baseUrl}}"],
              "path": ["health"]
            },
            "description": "Health check endpoint. No authentication required."
          },
          "response": []
        },
        {
          "name": "Service Info",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/",
              "host": ["{{baseUrl}}"],
              "path": [""]
            },
            "description": "Get service information and available endpoints. No authentication required."
          },
          "response": []
        }
      ]
    },
    {
      "name": "Bookmark Fields",
      "item": [
        {
          "name": "Get Bookmark Fields",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token."
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/bookmarks/fields",
              "host": ["{{baseUrl}}"],
              "path": ["api", "bookmarks", "fields"]
            },
            "description": "Get all bookmark fields. Requires 'communication:read' permission.\n\n**Note:** userId and tenantId are automatically extracted from the JWT token - no need to provide them in the request."
          },
          "response": []
        },
        {
          "name": "Create Bookmark Field",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token."
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"key\": \"memberName\",\n  \"label\": \"Member Name\",\n  \"path\": \"profile.personalInfo.forename\",\n  \"dataType\": \"string\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{baseUrl}}/api/bookmarks/fields",
              "host": ["{{baseUrl}}"],
              "path": ["api", "bookmarks", "fields"]
            },
            "description": "Create a new bookmark field. Requires 'communication:create' permission.\n\n**Required Fields:**\n- `key`: Unique identifier for the bookmark field (max 100 chars)\n- `label`: Human-readable label (max 200 chars)\n- `path`: JSON path to the data field (max 500 chars)\n\n**Optional Fields:**\n- `dataType`: Type of data - must be one of: `string`, `date`, or `number` (default: `string`)\n\n**Note:** userId and tenantId are automatically extracted from the JWT token - no need to provide them in the request."
          },
          "response": []
        },
        {
          "name": "Update Bookmark Field",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token."
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"label\": \"Member Full Name\",\n  \"path\": \"profile.personalInfo.fullName\",\n  \"dataType\": \"string\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{baseUrl}}/api/bookmarks/fields/{{bookmarkFieldId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "bookmarks", "fields", "{{bookmarkFieldId}}"]
            },
            "description": "Update a bookmark field. Requires 'communication:write' permission.\n\n**All fields are optional** - only include fields you want to update:\n- `key`: Unique identifier (max 100 chars)\n- `label`: Human-readable label (max 200 chars)\n- `path`: JSON path to the data field (max 500 chars)\n- `dataType`: Type of data - `string`, `date`, or `number`\n\n**Note:** userId and tenantId are automatically extracted from the JWT token - no need to provide them in the request."
          },
          "response": []
        },
        {
          "name": "Delete Bookmark Field",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token."
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/bookmarks/fields/{{bookmarkFieldId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "bookmarks", "fields", "{{bookmarkFieldId}}"]
            },
            "description": "Delete a bookmark field. Requires 'communication:delete' permission.\n\n**Note:** userId and tenantId are automatically extracted from the JWT token - no need to provide them in the request."
          },
          "response": []
        }
      ]
    },
    {
      "name": "Templates",
      "item": [
        {
          "name": "Upload Template",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token. Also used for OneDrive access if provided."
              }
            ],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "file",
                  "type": "file",
                  "src": [],
                  "description": "Upload a .docx file (required, max 50MB)"
                },
                {
                  "key": "name",
                  "value": "Welcome Letter Template",
                  "type": "text",
                  "description": "Template name (required, max 200 chars)"
                },
                {
                  "key": "description",
                  "value": "Template for welcome letters to new members",
                  "type": "text",
                  "description": "Template description (optional, max 500 chars)"
                },
                {
                  "key": "category",
                  "value": "letters",
                  "type": "text",
                  "description": "Template category (optional, max 100 chars)"
                },
                {
                  "key": "tempolateType",
                  "value": "letter",
                  "type": "text",
                  "description": "Template type (required, max 100 chars)"
                }
              ]
            },
            "url": {
              "raw": "{{baseUrl}}/api/templates/upload",
              "host": ["{{baseUrl}}"],
              "path": ["api", "templates", "upload"]
            },
            "description": "Upload a .docx template file to OneDrive/SharePoint and create a template record. Requires 'communication:create' permission.\n\n**Required Fields:**\n- `file`: .docx file (max 50MB)\n- `name`: Template name (max 200 chars)\n- `tempolateType`: Template type (max 100 chars)\n\n**Optional Fields:**\n- `description`: Template description (max 500 chars)\n- `category`: Template category (max 100 chars)\n\n**File Storage:**\n- Files are uploaded to OneDrive/SharePoint folder configured via `ONEDRIVE_TEMPLATE_FOLDER_ID` environment variable\n- If folder ID is not configured, files are uploaded to the authenticated user's OneDrive root folder\n- The OneDrive file ID is stored in the template record\n\n**Important Notes:** \n- userId and tenantId are automatically extracted from the JWT token\n- Template is automatically associated with your tenant\n- Microsoft Graph API must be configured with proper permissions (Files.ReadWrite.All)\n- See GRAPH_API_SETUP.md for Graph API configuration details\n- Do NOT include an `id` field in the request body (it will be automatically filtered out)\n- The `id` field in form data is ignored to prevent ObjectId validation errors"
          },
          "response": []
        },
        {
          "name": "Get Templates",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token."
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/templates?category=letters&tempolateType=letter",
              "host": ["{{baseUrl}}"],
              "path": ["api", "templates"],
              "query": [
                {
                  "key": "category",
                  "value": "letters",
                  "description": "Filter by category (optional). Templates are automatically filtered by your tenantId from token."
                },
                {
                  "key": "tempolateType",
                  "value": "letter",
                  "description": "Filter by template type (optional). Templates are automatically filtered by your tenantId from token."
                }
              ]
            },
            "description": "Get all templates for your tenant. Requires 'communication:read' permission.\n\n**Query Parameters (optional):**\n- `category`: Filter by category\n- `tempolateType`: Filter by template type\n\n**Note:** \n- Templates are automatically filtered by tenantId from your JWT token\n- You can only see templates from your own tenant"
          },
          "response": []
        },
        {
          "name": "Get Template",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token."
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/templates/{{templateId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "templates", "{{templateId}}"]
            },
            "description": "Get template details by ID. Requires 'communication:read' permission.\n\n**Note:** \n- Template must belong to your tenant (tenantId from token)\n- Returns 404 if template not found or belongs to different tenant"
          },
          "response": []
        },
        {
          "name": "Update Template",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token."
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Updated Template Name\",\n  \"description\": \"Updated description for the template\",\n  \"category\": \"updated-category\",\n  \"tempolateType\": \"updated-type\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{baseUrl}}/api/templates/{{templateId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "templates", "{{templateId}}"]
            },
            "description": "Update template metadata. Requires 'communication:write' permission.\n\n**All fields are optional** - only include fields you want to update:\n- `name`: Template name (max 200 chars)\n- `description`: Template description (max 500 chars)\n- `category`: Template category (max 100 chars)\n- `tempolateType`: Template type (max 100 chars)\n\n**Note:** \n- Template must belong to your tenant (tenantId from token)\n- Returns 404 if template not found or belongs to different tenant\n- OneDrive file is NOT updated, only the template metadata"
          },
          "response": []
        },
        {
          "name": "Delete Template",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token."
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/templates/{{templateId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "templates", "{{templateId}}"]
            },
            "description": "Delete a template. Requires 'communication:delete' permission.\n\n**Note:** \n- Template must belong to your tenant (tenantId from token)\n- Returns 404 if template not found or belongs to different tenant\n- OneDrive file is NOT deleted, only the template record is removed from the database"
          },
          "response": []
        },
        {
          "name": "Extract Placeholders",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token. Also used for OneDrive access."
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{baseUrl}}/api/templates/{{templateId}}/extract-placeholders",
              "host": ["{{baseUrl}}"],
              "path": [
                "api",
                "templates",
                "{{templateId}}",
                "extract-placeholders"
              ]
            },
            "description": "Extract placeholders from a template file stored in OneDrive. Requires 'communication:write' permission.\n\n**Request Body:** Empty object `{}`\n\n**Process:**\n1. Downloads the template file from OneDrive using the stored fileId\n2. Parses the .docx file to extract all placeholder expressions\n3. Saves the extracted placeholders to the template record\n4. Returns the array of placeholder names\n\n**Note:** \n- Template must belong to your tenant (tenantId from token)\n- Downloads template from OneDrive and extracts all placeholders using docxtemplater\n- Placeholders are saved to the template record\n- Returns array of placeholder names found in the template (e.g., `{memberName}`, `{date}`)\n- Microsoft Graph API must be configured for OneDrive access"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Letters",
      "item": [
        {
          "name": "Generate Letter",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}",
                "type": "text",
                "description": "JWT Bearer token (required). userId and tenantId are extracted from token. Also used for OneDrive access."
              },
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"memberId\": \"507f1f77bcf86cd799439011\",\n  \"templateId\": \"507f1f77bcf86cd799439012\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{baseUrl}}/api/letters/generate",
              "host": ["{{baseUrl}}"],
              "path": ["api", "letters", "generate"]
            },
            "description": "Generate a letter from a template with member data. Requires 'communication:create' permission.\n\n**Required Fields:**\n- `memberId`: Member ID (24-character MongoDB ObjectId) - the member for whom the letter is being generated\n- `templateId`: Template ID (24-character MongoDB ObjectId) - the template to use\n\n**Process:**\n1. Validates template and member IDs (ObjectId format)\n2. Fetches template file from OneDrive using stored fileId\n3. Collects member data from profile-service, subscription-service, and account-service\n4. Merges template with member data using bookmark fields mapping\n5. Uploads generated letter to Azure Blob Storage\n6. Creates a record in the database\n7. Returns download URL (valid for 1 hour)\n\n**Response:**\n- `letterId`: Generated letter record ID\n- `downloadUrl`: Azure Blob Storage SAS URL (valid for 1 hour)\n- `fileName`: Generated file name\n- `memberId`: Member ID\n- `templateId`: Template ID used\n\n**Note:** \n- Template must belong to your tenant (tenantId from token)\n- userId and tenantId are automatically extracted from the JWT token\n- Generated letter is stored in Azure Blob Storage with path: `{tenantId}/{memberId}/{fileName}`\n- Download URL is valid for 1 hour\n- Microsoft Graph API must be configured for OneDrive template access\n- Azure Blob Storage must be configured for letter storage"
          },
          "response": []
        }
      ]
    }
  ]
}
